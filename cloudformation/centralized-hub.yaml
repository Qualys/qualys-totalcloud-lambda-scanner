AWSTemplateFormatVersion: '2010-09-09'
Description: 'Qualys Lambda Scanner - Centralized Hub (Security Account)'

Parameters:
  QualysPod:
    Type: String
    Description: 'Qualys POD (e.g., US1, US2, EU1)'
    Default: 'US2'
    AllowedValues:
      - US1
      - US2
      - US3
      - US4
      - GOV1
      - EU1
      - EU2
      - EU3
      - IN1
      - CA1
      - AE1
      - UK1
      - AU1
      - KSA1

  QualysAccessToken:
    Type: String
    Description: 'Qualys Access Token (will be stored in Secrets Manager)'
    NoEcho: true

  EnableTagging:
    Type: String
    Description: 'Enable AWS Lambda resource tagging with scan results (set false if customer policy forbids Lambda tags)'
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'

  ArtifactsBucket:
    Type: String
    Description: 'S3 bucket containing Lambda code and layer artifacts'

  LambdaCodeKey:
    Type: String
    Description: 'S3 key for Lambda function code zip'
    Default: 'qualys-lambda-scanner/lambda-code.zip'

  LayerZipKey:
    Type: String
    Description: 'S3 key for QScanner Lambda layer zip'
    Default: 'qualys-lambda-scanner/qscanner-layer.zip'

  OrganizationId:
    Type: String
    Description: 'AWS Organization ID (e.g., o-xxxxxxxxxx) - used to allow all org accounts to send events'
    Default: ''

  SpokeAccountIds:
    Type: CommaDelimitedList
    Description: 'Comma-separated list of spoke account IDs (leave empty if using OrganizationId)'
    Default: ''

  EnableS3Results:
    Type: String
    Description: 'Create S3 bucket for storing scan results'
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'

  EnableSNSNotifications:
    Type: String
    Description: 'Create SNS topic for scan notifications'
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'

  EnableScanCache:
    Type: String
    Description: 'Enable DynamoDB scan cache to prevent duplicate scans'
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'

  CacheTTLDays:
    Type: Number
    Description: 'Number of days to cache scan results'
    Default: 30
    MinValue: 1
    MaxValue: 365

  ScannerReservedConcurrency:
    Type: Number
    Description: 'Reserved concurrent executions for Scanner Lambda (0 = no reservation, use for low-quota accounts)'
    Default: 0
    MinValue: 0
    MaxValue: 100

  ScannerMemorySize:
    Type: Number
    Description: 'Memory size for Scanner Lambda (MB)'
    Default: 2048
    MinValue: 512
    MaxValue: 10240

  ScannerTimeout:
    Type: Number
    Description: 'Timeout for Scanner Lambda (seconds)'
    Default: 900
    MinValue: 60
    MaxValue: 900

  ScannerEphemeralStorage:
    Type: Number
    Description: 'Ephemeral storage for Scanner Lambda (MB)'
    Default: 2048
    MinValue: 512
    MaxValue: 10240

  EnableBulkScan:
    Type: String
    Description: 'Enable bulk scan Lambda to scan existing functions across all spoke accounts'
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'

  BulkScanSchedule:
    Type: String
    Description: 'Cron schedule for periodic bulk scans (empty = manual only). Example: cron(0 2 ? * SUN *) for weekly Sunday 2am'
    Default: ''

  BulkScanCodeKey:
    Type: String
    Description: 'S3 key for bulk scan Lambda code zip'
    Default: 'qualys-lambda-scanner/bulk-scan.zip'

  BulkScanDefaultRegions:
    Type: String
    Description: 'Comma-separated list of regions for bulk scan (empty = current region only)'
    Default: ''

  EnableAccessLogging:
    Type: String
    Description: 'Enable S3 access logging for audit compliance (CIS Benchmark 3.6)'
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'

  ScannerExternalId:
    Type: String
    Description: 'External ID for cross-account role assumption (must match spoke deployments)'
    MinLength: 16
    MaxLength: 128
    NoEcho: true

Conditions:
  CreateS3Bucket: !Equals [!Ref EnableS3Results, 'true']
  CreateSNSTopic: !Equals [!Ref EnableSNSNotifications, 'true']
  CreateScanCache: !Equals [!Ref EnableScanCache, 'true']
  UseOrganization: !Not [!Equals [!Ref OrganizationId, '']]
  CreateBulkScan: !Equals [!Ref EnableBulkScan, 'true']
  CreateBulkScanSchedule: !And
    - !Condition CreateBulkScan
    - !Not [!Equals [!Ref BulkScanSchedule, '']]
  UseReservedConcurrency: !Not [!Equals [!Ref ScannerReservedConcurrency, 0]]
  CreateAccessLogging: !Equals [!Ref EnableAccessLogging, 'true']
  CreateAccessLoggingForResults: !And
    - !Condition CreateS3Bucket
    - !Condition CreateAccessLogging

Resources:
  # KMS key for encrypting sensitive data (DynamoDB, SQS, SNS, CloudWatch Logs)
  ScannerKMSKey:
    Type: AWS::KMS::Key
    Properties:
      Description: 'KMS key for Qualys Lambda Scanner encryption'
      EnableKeyRotation: true
      PendingWindowInDays: 30
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: EnableIAMUserPermissions
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'kms:*'
            Resource: '*'
          - Sid: AllowCloudWatchLogs
            Effect: Allow
            Principal:
              Service: !Sub 'logs.${AWS::Region}.amazonaws.com'
            Action:
              - 'kms:Encrypt*'
              - 'kms:Decrypt*'
              - 'kms:ReEncrypt*'
              - 'kms:GenerateDataKey*'
              - 'kms:Describe*'
            Resource: '*'
            Condition:
              ArnLike:
                'kms:EncryptionContext:aws:logs:arn': !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*'
          - Sid: AllowSNS
            Effect: Allow
            Principal:
              Service: sns.amazonaws.com
            Action:
              - 'kms:Decrypt'
              - 'kms:GenerateDataKey*'
            Resource: '*'
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-kms-key'
        - Key: ManagedBy
          Value: CloudFormation

  ScannerKMSKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub 'alias/${AWS::StackName}-scanner'
      TargetKeyId: !Ref ScannerKMSKey

  # S3 Access Logs Bucket (CIS Benchmark 3.6)
  AccessLogsBucket:
    Type: AWS::S3::Bucket
    Condition: CreateAccessLogging
    Properties:
      BucketName: !Sub '${AWS::StackName}-access-logs-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldAccessLogs
            Status: Enabled
            ExpirationInDays: 90
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerPreferred
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-access-logs'
        - Key: ManagedBy
          Value: CloudFormation

  AccessLogsBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Condition: CreateAccessLogging
    Properties:
      Bucket: !Ref AccessLogsBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: S3ServerAccessLogsPolicy
            Effect: Allow
            Principal:
              Service: logging.s3.amazonaws.com
            Action: s3:PutObject
            Resource: !Sub '${AccessLogsBucket.Arn}/*'
            Condition:
              ArnLike:
                'aws:SourceArn': !Sub 'arn:aws:s3:::${AWS::StackName}-*'
              StringEquals:
                'aws:SourceAccount': !Ref AWS::AccountId
          - Sid: DenyUnencryptedTransport
            Effect: Deny
            Principal: '*'
            Action: 's3:*'
            Resource:
              - !GetAtt AccessLogsBucket.Arn
              - !Sub '${AccessLogsBucket.Arn}/*'
            Condition:
              Bool:
                'aws:SecureTransport': 'false'

  # Central EventBridge Bus
  CentralEventBus:
    Type: AWS::Events::EventBus
    Properties:
      Name: !Sub '${AWS::StackName}-central-bus'

  # EventBridge Bus Policy to allow spoke accounts to send events
  CentralEventBusPolicy:
    Type: AWS::Events::EventBusPolicy
    Properties:
      EventBusName: !Ref CentralEventBus
      StatementId: AllowSpokeAccountsToPutEvents
      Statement:
        Effect: Allow
        Principal:
          AWS: !If
            - UseOrganization
            - '*'
            - !Ref SpokeAccountIds
        Action:
          - events:PutEvents
        Resource: !GetAtt CentralEventBus.Arn
        Condition: !If
          - UseOrganization
          - StringEquals:
              aws:PrincipalOrgID: !Ref OrganizationId
          - !Ref AWS::NoValue

  # Secrets Manager Secret for Qualys Credentials
  QualysCredentialsSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub '${AWS::StackName}-qualys-credentials'
      Description: 'Qualys credentials for Lambda scanner'
      SecretString: !Sub |
        {
          "qualys_pod": "${QualysPod}",
          "qualys_access_token": "${QualysAccessToken}"
        }
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-qualys-credentials'
        - Key: ManagedBy
          Value: CloudFormation

  # S3 Bucket for Scan Results (Optional)
  ScanResultsBucket:
    Type: AWS::S3::Bucket
    Condition: CreateS3Bucket
    Properties:
      BucketName: !Sub '${AWS::StackName}-scan-results-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !Ref ScannerKMSKey
            BucketKeyEnabled: true
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      LoggingConfiguration: !If
        - CreateAccessLoggingForResults
        - DestinationBucketName: !Ref AccessLogsBucket
          LogFilePrefix: 'scan-results/'
        - !Ref AWS::NoValue
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldScans
            Status: Enabled
            ExpirationInDays: 90
            NoncurrentVersionExpirationInDays: 30
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-scan-results'
        - Key: ManagedBy
          Value: CloudFormation

  # SNS Topic for Notifications (Optional)
  ScanNotificationsTopic:
    Type: AWS::SNS::Topic
    Condition: CreateSNSTopic
    Properties:
      TopicName: !Sub '${AWS::StackName}-scan-notifications'
      DisplayName: 'Qualys Lambda Scan Notifications'
      KmsMasterKeyId: !Ref ScannerKMSKey
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-scan-notifications'
        - Key: ManagedBy
          Value: CloudFormation

  # DynamoDB table for scan caching
  ScanCacheTable:
    Type: AWS::DynamoDB::Table
    Condition: CreateScanCache
    Properties:
      TableName: !Sub '${AWS::StackName}-scan-cache'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: function_arn
          AttributeType: S
      KeySchema:
        - AttributeName: function_arn
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
        KMSMasterKeyId: !Ref ScannerKMSKey
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-scan-cache'
        - Key: ManagedBy
          Value: CloudFormation

  # Dead Letter Queue for Scanner Lambda
  ScannerDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${AWS::StackName}-scanner-dlq'
      MessageRetentionPeriod: 1209600  # 14 days
      KmsMasterKeyId: !Ref ScannerKMSKey
      KmsDataKeyReusePeriodSeconds: 300
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-scanner-dlq'
        - Key: ManagedBy
          Value: CloudFormation

  # IAM Role for Scanner Lambda to assume roles in spoke accounts
  ScannerLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${AWS::StackName}-scanner-lambda-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: ScannerLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # ECR Auth Token - requires Resource: "*" per AWS documentation
              - Sid: ECRAuthToken
                Effect: Allow
                Action:
                  - ecr:GetAuthorizationToken
                Resource: '*'

              # ECR Repository Access - all regions, scoped to account
              - Sid: ECRRepositoryAccess
                Effect: Allow
                Action:
                  - ecr:BatchCheckLayerAvailability
                  - ecr:GetDownloadUrlForLayer
                  - ecr:BatchGetImage
                  - ecr:DescribeImages
                Resource: !Sub 'arn:aws:ecr:*:${AWS::AccountId}:repository/*'

              # Lambda Read Permissions (for own account, all regions)
              - Sid: LambdaRead
                Effect: Allow
                Action:
                  - lambda:GetFunction
                  - lambda:GetFunctionConfiguration
                Resource: !Sub 'arn:aws:lambda:*:${AWS::AccountId}:function:*'

              # Lambda Tag with restriction to QualysScan* tags only (all regions)
              - Sid: LambdaTag
                Effect: Allow
                Action:
                  - lambda:TagResource
                Resource: !Sub 'arn:aws:lambda:*:${AWS::AccountId}:function:*'
                Condition:
                  'ForAllValues:StringLike':
                    'aws:TagKeys':
                      - 'QualysScan*'

              # Secrets Manager Permissions
              - Sid: SecretsManagerRead
                Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: !Ref QualysCredentialsSecret

              # STS Assume Role (cross-account) - scoped to organization when using OrganizationId
              # The spoke trust policy provides additional security via ExternalId validation
              # When using OrganizationId: restricts to accounts within the organization
              # When using explicit SpokeAccountIds: spoke trust policy enforces access control
              - Sid: AssumeRoleInSpokeAccounts
                Effect: Allow
                Action:
                  - sts:AssumeRole
                Resource: 'arn:aws:iam::*:role/qualys-lambda-scanner-spoke-role'
                Condition: !If
                  - UseOrganization
                  - StringEquals:
                      'aws:ResourceOrgID': !Ref OrganizationId
                  - !Ref AWS::NoValue

              # SQS Dead Letter Queue
              - Sid: SQSDeadLetterQueue
                Effect: Allow
                Action:
                  - sqs:SendMessage
                Resource: !GetAtt ScannerDeadLetterQueue.Arn

              # CloudWatch Metrics - requires Resource: "*" but restricted by namespace condition
              - Sid: CloudWatchMetrics
                Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                Resource: '*'
                Condition:
                  StringEquals:
                    'cloudwatch:namespace': 'QualysLambdaScanner'

              # KMS Access for encryption/decryption
              - Sid: KMSAccess
                Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:GenerateDataKey
                Resource: !GetAtt ScannerKMSKey.Arn

              # X-Ray Tracing permissions
              - Sid: XRayTracing
                Effect: Allow
                Action:
                  - xray:PutTraceSegments
                  - xray:PutTelemetryRecords
                Resource: '*'

              # DynamoDB Access (if enabled)
              - !If
                - CreateScanCache
                - Sid: DynamoDBAccess
                  Effect: Allow
                  Action:
                    - dynamodb:GetItem
                    - dynamodb:PutItem
                    - dynamodb:UpdateItem
                  Resource: !GetAtt ScanCacheTable.Arn
                - !Ref AWS::NoValue

              # S3 Permissions (if enabled)
              - !If
                - CreateS3Bucket
                - Sid: S3Write
                  Effect: Allow
                  Action:
                    - s3:PutObject
                  Resource: !Sub '${ScanResultsBucket.Arn}/*'
                - !Ref AWS::NoValue

              # SNS Permissions (if enabled)
              - !If
                - CreateSNSTopic
                - Sid: SNSPublish
                  Effect: Allow
                  Action:
                    - sns:Publish
                  Resource: !Ref ScanNotificationsTopic
                - !Ref AWS::NoValue

      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-scanner-lambda-role'
        - Key: ManagedBy
          Value: CloudFormation

  # CloudWatch Log Group for Scanner Lambda
  ScannerLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${AWS::StackName}-scanner'
      RetentionInDays: 90
      KmsKeyId: !GetAtt ScannerKMSKey.Arn

  # Lambda Layer containing QScanner binary
  QScannerLayer:
    Type: AWS::Lambda::LayerVersion
    Properties:
      LayerName: !Sub '${AWS::StackName}-qscanner-binary'
      Description: 'QScanner binary for Lambda vulnerability scanning'
      Content:
        S3Bucket: !Ref ArtifactsBucket
        S3Key: !Ref LayerZipKey
      CompatibleRuntimes:
        - python3.11
        - python3.10
        - python3.9
      CompatibleArchitectures:
        - x86_64

  # Scanner Lambda Function
  ScannerLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-scanner'
      Description: 'Scans Lambda functions using Qualys QScanner (centralized)'
      Runtime: python3.11
      Handler: lambda_function.lambda_handler
      Code:
        S3Bucket: !Ref ArtifactsBucket
        S3Key: !Ref LambdaCodeKey
      Role: !GetAtt ScannerLambdaRole.Arn
      MemorySize: !Ref ScannerMemorySize
      Timeout: !Ref ScannerTimeout
      # Reserved concurrency prevents runaway invocations (set to 0 for low-quota accounts)
      ReservedConcurrentExecutions: !If [UseReservedConcurrency, !Ref ScannerReservedConcurrency, !Ref 'AWS::NoValue']
      EphemeralStorage:
        Size: !Ref ScannerEphemeralStorage
      Layers:
        - !Ref QScannerLayer
      DeadLetterConfig:
        TargetArn: !GetAtt ScannerDeadLetterQueue.Arn
      # Enable X-Ray tracing for debugging and auditing
      TracingConfig:
        Mode: Active
      Environment:
        Variables:
          QUALYS_SECRET_ARN: !Ref QualysCredentialsSecret
          RESULTS_S3_BUCKET: !If [CreateS3Bucket, !Ref ScanResultsBucket, '']
          SNS_TOPIC_ARN: !If [CreateSNSTopic, !Ref ScanNotificationsTopic, '']
          SCAN_CACHE_TABLE: !If [CreateScanCache, !Ref ScanCacheTable, '']
          SCAN_TIMEOUT: '300'
          CACHE_TTL_DAYS: !Ref CacheTTLDays
          CROSS_ACCOUNT_ROLE_NAME: 'qualys-lambda-scanner-spoke-role'
          SCANNER_EXTERNAL_ID: !Ref ScannerExternalId
          QSCANNER_PATH: '/opt/bin/qscanner'
          ENABLE_TAGGING: !Ref EnableTagging
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-scanner'
        - Key: ManagedBy
          Value: CloudFormation

  # EventBridge Rule on Central Bus
  CentralEventRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub '${AWS::StackName}-central-rule'
      Description: 'Trigger scanner for Lambda events from all accounts'
      EventBusName: !Ref CentralEventBus
      State: ENABLED
      EventPattern:
        source:
          - aws.lambda
        detail-type:
          - AWS API Call via CloudTrail
        detail:
          eventSource:
            - lambda.amazonaws.com
          eventName:
            - CreateFunction20150331
            - UpdateFunctionCode20150331v2
            - UpdateFunctionConfiguration20150331v2
      Targets:
        - Arn: !GetAtt ScannerLambdaFunction.Arn
          Id: ScannerLambdaTarget

  # Permission for EventBridge to invoke Lambda
  CentralEventPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ScannerLambdaFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt CentralEventRule.Arn

  # =============================================================================
  # Bulk Scan Lambda (Optional) - Scans existing functions across all accounts
  # =============================================================================

  # IAM Role for Bulk Scan Lambda
  BulkScanLambdaRole:
    Type: AWS::IAM::Role
    Condition: CreateBulkScan
    Properties:
      RoleName: !Sub '${AWS::StackName}-bulk-scan-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: BulkScanPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # List Lambda functions in hub account
              - Sid: ListLambdaFunctions
                Effect: Allow
                Action:
                  - lambda:ListFunctions
                Resource: '*'
              # Invoke the scanner Lambda
              - Sid: InvokeScanner
                Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource: !GetAtt ScannerLambdaFunction.Arn
              # Assume role in spoke accounts to list their functions
              # Scoped to organization when OrganizationId is provided
              - Sid: AssumeRoleInSpokeAccounts
                Effect: Allow
                Action:
                  - sts:AssumeRole
                Resource: 'arn:aws:iam::*:role/qualys-lambda-scanner-spoke-role'
                Condition: !If
                  - UseOrganization
                  - StringEquals:
                      'aws:ResourceOrgID': !Ref OrganizationId
                  - !Ref AWS::NoValue
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-bulk-scan-role'
        - Key: ManagedBy
          Value: CloudFormation

  # Bulk Scan Lambda Function
  BulkScanLambdaFunction:
    Type: AWS::Lambda::Function
    Condition: CreateBulkScan
    Properties:
      FunctionName: !Sub '${AWS::StackName}-bulk-scan'
      Description: 'Scans all existing Lambda functions across spoke accounts'
      Runtime: python3.11
      Handler: bulk_scan.lambda_handler
      Code:
        S3Bucket: !Ref ArtifactsBucket
        S3Key: !Ref BulkScanCodeKey
      Role: !GetAtt BulkScanLambdaRole.Arn
      MemorySize: 256
      Timeout: 900
      Environment:
        Variables:
          SCANNER_FUNCTION_NAME: !Ref ScannerLambdaFunction
          CROSS_ACCOUNT_ROLE_NAME: 'qualys-lambda-scanner-spoke-role'
          SCANNER_EXTERNAL_ID: !Ref ScannerExternalId
          EXCLUDE_PATTERNS: !Sub '${AWS::StackName}-scanner,${AWS::StackName}-bulk-scan'
          INVOCATION_DELAY_MS: '100'
          DEFAULT_REGIONS: !Ref BulkScanDefaultRegions
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-bulk-scan'
        - Key: ManagedBy
          Value: CloudFormation

  # CloudWatch Log Group for Bulk Scan Lambda
  BulkScanLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Condition: CreateBulkScan
    Properties:
      LogGroupName: !Sub '/aws/lambda/${AWS::StackName}-bulk-scan'
      RetentionInDays: 90
      KmsKeyId: !GetAtt ScannerKMSKey.Arn

  # EventBridge Rule for scheduled bulk scans (optional)
  BulkScanScheduleRule:
    Type: AWS::Events::Rule
    Condition: CreateBulkScanSchedule
    Properties:
      Name: !Sub '${AWS::StackName}-bulk-scan-schedule'
      Description: 'Scheduled bulk scan of existing Lambda functions'
      State: ENABLED
      ScheduleExpression: !Ref BulkScanSchedule
      Targets:
        - Arn: !GetAtt BulkScanLambdaFunction.Arn
          Id: BulkScanTarget
          Input: '{}'

  # Permission for EventBridge to invoke Bulk Scan Lambda
  BulkScanSchedulePermission:
    Type: AWS::Lambda::Permission
    Condition: CreateBulkScanSchedule
    Properties:
      FunctionName: !Ref BulkScanLambdaFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt BulkScanScheduleRule.Arn

  # CloudWatch Alarms for monitoring scanner health
  ScannerErrorsAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: CreateSNSTopic
    Properties:
      AlarmName: !Sub '${AWS::StackName}-scanner-errors'
      AlarmDescription: 'Scanner Lambda has errors'
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Dimensions:
        - Name: FunctionName
          Value: !Ref ScannerLambdaFunction
      AlarmActions:
        - !Ref ScanNotificationsTopic

  ScannerThrottlesAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: CreateSNSTopic
    Properties:
      AlarmName: !Sub '${AWS::StackName}-scanner-throttles'
      AlarmDescription: 'Scanner Lambda is being throttled'
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Dimensions:
        - Name: FunctionName
          Value: !Ref ScannerLambdaFunction
      AlarmActions:
        - !Ref ScanNotificationsTopic

  ScannerDLQMessagesAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: CreateSNSTopic
    Properties:
      AlarmName: !Sub '${AWS::StackName}-scanner-dlq-messages'
      AlarmDescription: 'Messages in scanner DLQ - indicates failed scans'
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Statistic: Average
      Period: 60
      EvaluationPeriods: 1
      Threshold: 0
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Dimensions:
        - Name: QueueName
          Value: !GetAtt ScannerDeadLetterQueue.QueueName
      AlarmActions:
        - !Ref ScanNotificationsTopic

  ScannerDurationAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: CreateSNSTopic
    Properties:
      AlarmName: !Sub '${AWS::StackName}-scanner-duration'
      AlarmDescription: 'Scanner Lambda approaching timeout threshold'
      MetricName: Duration
      Namespace: AWS/Lambda
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: !Sub
        - '${TimeoutMillis}'
        - TimeoutMillis: !Join ['', [!Ref ScannerTimeout, '000']]
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Dimensions:
        - Name: FunctionName
          Value: !Ref ScannerLambdaFunction
      AlarmActions:
        - !Ref ScanNotificationsTopic

  # DynamoDB Throttling Alarm
  DynamoDBThrottlingAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: CreateScanCache
    Properties:
      AlarmName: !Sub '${AWS::StackName}-dynamodb-throttling'
      AlarmDescription: 'DynamoDB requests being throttled - may need capacity increase'
      MetricName: ThrottledRequests
      Namespace: AWS/DynamoDB
      Statistic: Sum
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Dimensions:
        - Name: TableName
          Value: !Ref ScanCacheTable
      AlarmActions: !If
        - CreateSNSTopic
        - - !Ref ScanNotificationsTopic
        - !Ref AWS::NoValue

  # Lambda Concurrent Executions Alarm
  ScannerConcurrencyAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: CreateSNSTopic
    Properties:
      AlarmName: !Sub '${AWS::StackName}-scanner-concurrency'
      AlarmDescription: 'Scanner Lambda approaching reserved concurrency limit'
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Statistic: Maximum
      Period: 60
      EvaluationPeriods: 2
      # Alert when reaching 80% of reserved concurrency
      Threshold: !Sub
        - '${ConcurrencyThreshold}'
        - ConcurrencyThreshold: !Join ['', [!Ref ScannerReservedConcurrency, '']]
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Dimensions:
        - Name: FunctionName
          Value: !Ref ScannerLambdaFunction
      AlarmActions:
        - !Ref ScanNotificationsTopic

  # Scan Success Rate Alarm (using custom metric from Lambda)
  ScanSuccessRateAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: CreateSNSTopic
    Properties:
      AlarmName: !Sub '${AWS::StackName}-scan-success-rate'
      AlarmDescription: 'Low scan success rate - investigate failures'
      MetricName: ScanSuccess
      Namespace: QualysLambdaScanner
      Statistic: Average
      Period: 300
      EvaluationPeriods: 3
      Threshold: 0.9
      ComparisonOperator: LessThanThreshold
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref ScanNotificationsTopic

Outputs:
  CentralEventBusArn:
    Description: 'ARN of the central EventBridge bus'
    Value: !GetAtt CentralEventBus.Arn
    Export:
      Name: !Sub '${AWS::StackName}-CentralEventBusArn'

  CentralEventBusName:
    Description: 'Name of the central EventBridge bus'
    Value: !Ref CentralEventBus
    Export:
      Name: !Sub '${AWS::StackName}-CentralEventBusName'

  QScannerLayerArn:
    Description: 'ARN of the QScanner Lambda Layer'
    Value: !Ref QScannerLayer
    Export:
      Name: !Sub '${AWS::StackName}-QScannerLayerArn'

  ScannerLambdaArn:
    Description: 'ARN of the Scanner Lambda function'
    Value: !GetAtt ScannerLambdaFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-ScannerLambdaArn'

  QualysSecretArn:
    Description: 'ARN of the Qualys credentials secret'
    Value: !Ref QualysCredentialsSecret
    Export:
      Name: !Sub '${AWS::StackName}-QualysSecretArn'

  ScanResultsBucketName:
    Description: 'Name of the S3 bucket for scan results'
    Condition: CreateS3Bucket
    Value: !Ref ScanResultsBucket
    Export:
      Name: !Sub '${AWS::StackName}-ScanResultsBucket'

  ScanNotificationsTopicArn:
    Description: 'ARN of the SNS topic for scan notifications'
    Condition: CreateSNSTopic
    Value: !Ref ScanNotificationsTopic
    Export:
      Name: !Sub '${AWS::StackName}-ScanNotificationsTopic'

  SecurityAccountId:
    Description: 'Security account ID (for spoke configuration)'
    Value: !Ref AWS::AccountId
    Export:
      Name: !Sub '${AWS::StackName}-SecurityAccountId'

  KMSKeyArn:
    Description: 'ARN of the KMS key used for encryption'
    Value: !GetAtt ScannerKMSKey.Arn
    Export:
      Name: !Sub '${AWS::StackName}-KMSKeyArn'

  ScanCacheTableName:
    Description: 'Name of the DynamoDB scan cache table'
    Condition: CreateScanCache
    Value: !Ref ScanCacheTable
    Export:
      Name: !Sub '${AWS::StackName}-ScanCacheTable'

  BulkScanLambdaArn:
    Description: 'ARN of the Bulk Scan Lambda function'
    Condition: CreateBulkScan
    Value: !GetAtt BulkScanLambdaFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-BulkScanLambdaArn'

  AccessLogsBucketName:
    Description: 'Name of the S3 bucket for access logs'
    Condition: CreateAccessLogging
    Value: !Ref AccessLogsBucket
    Export:
      Name: !Sub '${AWS::StackName}-AccessLogsBucket'
